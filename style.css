// ===============================
// FUFATHON â€“ LIVE pÅ™es Worker /state + GOALY
// ===============================

const WORKER_BASE = "https://fufathon-se-proxy.pajujka191.workers.dev";

// ğŸ¯ CÃLE
const MONEY_GOAL_KC = 200000;
const TIME_GOAL_MINUTES = 12 * 60;

// ğŸ¯ GOALY
const GOALS = [
  { amount: 5000,  name: "Movie night ğŸ¬" },
  { amount: 10000, name: "Q&A bez cenzury ğŸ˜" },
  { amount: 15000, name: "Horror Night ğŸ‘»" },
  { amount: 20000, name: "JÃ­dlo podle chatu ğŸ•" },
  { amount: 25000, name: "KostÃ½m stream ğŸ¤¡" },
  { amount: 30000, name: "Just Dance ğŸ’ƒ" },
  { amount: 35000, name: "Lego ğŸ§±" },
  { amount: 40000, name: "AsijskÃ¡ ochutnÃ¡vka ğŸ£" },
  { amount: 45000, name: "Minecraft SpeedRun DUO â›ï¸" },
  { amount: 50000, name: "Karaoke stream ğŸ¤" },
  { amount: 55000, name: "Battle Royale Challenge ğŸ”«" },
  { amount: 60000, name: "Bowling ğŸ³" },
  { amount: 65000, name: "Try Not To Laugh ğŸ˜‚" },
  { amount: 70000, name: "BÄ›Å¾eckÃ½ pÃ¡s ğŸƒ" },
  { amount: 75000, name: "Drunk Stream ğŸ»" },
  { amount: 80000, name: "12h Stream ve stoje ğŸ§" },
  { amount: 85000, name: "Split Fiction w/ Juraj ğŸ®" },
  { amount: 90000, name: "Mystery box opening ğŸ" },
  { amount: 95000, name: "Turnaj v LoLku ğŸ†" },
  { amount: 100000, name: "StodolnÃ­ ve stylu âœ¨" },
  { amount: 110000, name: "MotokÃ¡ry ğŸï¸" },
  { amount: 120000, name: "ASMR stream ğŸŒ™" },
  { amount: 125000, name: "Bolt Tower âš¡" },
  { amount: 130000, name: "OtuÅ¾ovÃ¡nÃ­ ğŸ§Š" },
  { amount: 140000, name: "MiniGolf â›³" },
  { amount: 150000, name: "VÃ­Å™ivka â™¨ï¸" },
  { amount: 160000, name: "ZÃ¡Å¾itkovÃ© ART studio ğŸ¨" },
  { amount: 170000, name: "JÃ­zda na koni ğŸ´" },
  { amount: 180000, name: "VÃ½Å¡lap na Lysou horu ğŸ¥¾" },
  { amount: 190000, name: "TetovÃ¡nÃ­ ğŸ–‹ï¸" },
  { amount: 200000, name: "VÃ­kend v Praze ğŸ™ï¸" },
];

let lastConfettiCounter = 0;

// LokÃ¡lnÃ­ demo stav (na tlaÄÃ­tka dole) â€“ Worker se tÃ­m nemÄ›nÃ­
let demoState = {
  totalMinutes: 0,
  totalMoneyKc: 0,
  subs: { t1: 0, t2: 0, t3: 0 },
  events: ["ğŸ’—âœ¨ FUFATHON je LIVE â€“ ÄekÃ¡m na prvnÃ­ sub/donate ğŸ’œ"],
  bumpConfetti: 0,
};

// -------------------------------
// HELPERS
// -------------------------------
function formatNumber(n) {
  return new Intl.NumberFormat("cs-CZ").format(n);
}

function formatMoney(n) {
  return `${formatNumber(n)} KÄ`;
}

function setText(id, value) {
  const el = document.getElementById(id);
  if (el) el.innerText = value;
}

function setWidth(id, percent) {
  const el = document.getElementById(id);
  if (el) el.style.width = `${Math.min(Math.max(percent, 0), 100)}%`;
}

function confettiBoom() {
  if (typeof confetti !== "function") return;
  confetti({
    particleCount: 120,
    spread: 70,
    origin: { y: 0.6 },
    colors: ["#ff9ad5", "#ffd6f6", "#a970ff"],
  });
}

// -------------------------------
// GOALS
// -------------------------------
function renderGoals(totalMoneyKc) {
  const goalsSummary = document.getElementById("goalsSummary");
  const goalsProgress = document.getElementById("goalsProgress");
  const goalsList = document.getElementById("goalsList");

  if (goalsSummary) {
    goalsSummary.innerText = `${formatNumber(totalMoneyKc)} / ${formatNumber(MONEY_GOAL_KC)} KÄ`;
  }

  const pct = (totalMoneyKc / MONEY_GOAL_KC) * 100;
  if (goalsProgress) {
    goalsProgress.style.width = `${Math.min(Math.max(pct, 0), 100)}%`;
  }

  if (!goalsList) return;

  goalsList.innerHTML = "";

  const nextGoal = GOALS.find(g => totalMoneyKc < g.amount)?.amount ?? null;

  for (const g of GOALS) {
    const reached = totalMoneyKc >= g.amount;
    const isNext = nextGoal !== null && g.amount === nextGoal;

    const li = document.createElement("li");
    li.className = `goal-item ${reached ? "reached" : ""} ${isNext ? "next" : ""}`;

    li.innerHTML = `
      <div class="goal-left">
        <div class="goal-name"><span class="heart">ğŸ’—</span> ${g.name}</div>
        <div class="goal-meta">
          <span>${reached ? "âœ… splnÄ›no" : (isNext ? "âœ¨ nejbliÅ¾Å¡Ã­" : "â³ ÄekÃ¡")}</span>
        </div>
      </div>
      <div class="goal-amount">${formatNumber(g.amount)} KÄ</div>
    `;

    goalsList.appendChild(li);
  }
}

// -------------------------------
// RENDER STATE
// -------------------------------
function renderState(state) {
  const totalMinutes = state.totalMinutes || 0;
  const totalMoneyKc = state.totalMoneyKc || 0;

  // timer
  const h = Math.floor(totalMinutes / 60);
  const m = totalMinutes % 60;
  setText("timer", `${String(h).padStart(2, "0")} h ${String(m).padStart(2, "0")} min`);

  // end time (od teÄ + totalMinutes)
  const end = new Date(Date.now() + totalMinutes * 60000);
  setText("endTime", "Konec: " + end.toLocaleString("cs-CZ"));

  // money + subs
  setText("money", formatMoney(totalMoneyKc));
  setText("t1", state.subs?.t1 ?? 0);
  setText("t2", state.subs?.t2 ?? 0);
  setText("t3", state.subs?.t3 ?? 0);

  // progress bary
  const moneyPct = (totalMoneyKc / MONEY_GOAL_KC) * 100;
  setWidth("moneyProgress", moneyPct);

  const timePct = (totalMinutes / TIME_GOAL_MINUTES) * 100;
  setWidth("timeProgress", timePct);

  // texty
  const moneyText = document.getElementById("moneyProgressText");
  if (moneyText) {
    moneyText.innerText = `${formatNumber(totalMoneyKc)} / ${formatNumber(MONEY_GOAL_KC)} KÄ`;
  }
  setText("timeProgressText", `${Math.min(timePct, 100).toFixed(0)}%`);

  // events
  const ul = document.getElementById("events");
  if (ul && Array.isArray(state.events)) {
    ul.innerHTML = "";
    for (const text of state.events) {
      const li = document.createElement("li");
      li.textContent = text;
      ul.appendChild(li);
    }
  }

  // goals
  renderGoals(totalMoneyKc);

  // confetti (po subu)
  const bump = state.bumpConfetti || 0;
  if (bump > lastConfettiCounter) {
    confettiBoom();
    lastConfettiCounter = bump;
  }
}

// -------------------------------
// FETCH STATE (Worker)
// -------------------------------
async function fetchState() {
  try {
    const res = await fetch(`${WORKER_BASE}/state`, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const state = await res.json();
    renderState(state);
  } catch (e) {
    // kdyÅ¾ Worker zrovna nejede, drÅ¾Ã­me aspoÅˆ demo
    renderState(demoState);
  }
}

// -------------------------------
// THEME TOGGLE
// -------------------------------
function initTheme() {
  const saved = localStorage.getItem("fufa_theme");
  if (saved === "light" || saved === "dark") {
    document.documentElement.setAttribute("data-theme", saved);
  }
}

function toggleTheme() {
  const current = document.documentElement.getAttribute("data-theme") || "dark";
  const next = current === "dark" ? "light" : "dark";
  document.documentElement.setAttribute("data-theme", next);
  localStorage.setItem("fufa_theme", next);
}

// -------------------------------
// DEMO BUTTONS
// -------------------------------
function pushEvent(text) {
  demoState.events = [text, ...demoState.events].slice(0, 20);
}

function demoSub(tier) {
  if (tier === 1) { demoState.subs.t1 += 1; demoState.totalMinutes += 10; pushEvent(`ğŸ’— Demo â€“ T1 sub (+10 min)`); }
  if (tier === 2) { demoState.subs.t2 += 1; demoState.totalMinutes += 15; pushEvent(`ğŸ’— Demo â€“ T2 sub (+15 min)`); }
  if (tier === 3) { demoState.subs.t3 += 1; demoState.totalMinutes += 20; pushEvent(`ğŸ’— Demo â€“ T3 sub (+20 min)`); }
  demoState.bumpConfetti += 1;
  renderState(demoState);
  confettiBoom();
}

function demoDonate100() {
  demoState.totalMoneyKc += 100;
  demoState.totalMinutes += 15;
  pushEvent(`ğŸ’— Demo â€“ donate 100 KÄ (+15 min)`);
  renderState(demoState);
}

function demoReset() {
  demoState = {
    totalMinutes: 0,
    totalMoneyKc: 0,
    subs: { t1: 0, t2: 0, t3: 0 },
    events: ["ğŸ’—âœ¨ FUFATHON je LIVE â€“ ÄekÃ¡m na prvnÃ­ sub/donate ğŸ’œ"],
    bumpConfetti: 0,
  };
  lastConfettiCounter = 0;
  renderState(demoState);
}

// -------------------------------
// INIT
// -------------------------------
document.addEventListener("DOMContentLoaded", () => {
  initTheme();

  const btnTheme = document.getElementById("themeToggle");
  if (btnTheme) btnTheme.addEventListener("click", toggleTheme);

  // demo
  document.getElementById("demoT1")?.addEventListener("click", () => demoSub(1));
  document.getElementById("demoT2")?.addEventListener("click", () => demoSub(2));
  document.getElementById("demoT3")?.addEventListener("click", () => demoSub(3));
  document.getElementById("demoDono")?.addEventListener("click", demoDonate100);
  document.getElementById("demoReset")?.addEventListener("click", demoReset);

  // start
  fetchState();
  setInterval(fetchState, 5000);
});
